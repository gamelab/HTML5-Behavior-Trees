Kiwi.Plugins.AITree={name:"AITree",version:"1.0"};Kiwi.PluginManager.register(Kiwi.Plugins.AITree);Kiwi.Plugins.AITree.AI=function(){this.root=undefined;this.uniqueChildren=[];this.update=function(){var e=4;if(this.root.update!=undefined){e=this.root.update()}for(var t=0;t<this.uniqueChildren.length;t++){this.uniqueChildren[t].reset()}return e};this.updateCensus=function(){var e=this.root.getDescendants();this.uniqueChildren=[this.root];for(var t=0;t<e.length;t++){if(this.uniqueChildren.indexOf(e[t])==-1){this.uniqueChildren.push(e[t])}}return true};this.setRoot=function(e){if(e!=undefined){this.root=e;this.root.addParent(this);this.updateCensus()}};this.addChild=function(e){return this.setRoot(e)};this.hasAncestor=function(e){return false};return this};Kiwi.Plugins.AITree.AITreeOuterNode=function(e){this.name="untitledNode";if(e!=undefined)if(e.name!=undefined)this.name=e.name;this.STATUS_READY=0;this.STATUS_RUNNING=1;this.STATUS_SUCCESS=2;this.STATUS_FAILURE=3;this.STATUS_ERROR=4;this.status=this.STATUS_READY;this.runningDirty=false;this.runsParent=true;this.parents=[];this.update=function(){this.onUpdate();this.run();if(this.status==this.STATUS_RUNNING)this.runningDirty=true;else this.runningDirty=false;return this.status};this.onUpdate=function(){};this.run=function(){};this.reset=function(){if(this.status==this.STATUS_RUNNING&&this.runningDirty){this.runningDirty=false;return}if(this.status==this.STATUS_ERROR){console.log("Error detected in "+this.name,this)}this.status=this.STATUS_READY};this.addParent=function(e){if(this.parents.indexOf(e)==-1){this.parents.push(e);return true}return false};this.removeParent=function(e){var t=this.parents.indexOf(e);if(t!=-1){this.parents.splice(t,1);return true}return false};this.updateCensus=function(){for(var e=0;e<this.parents.length;e++){var t=this.parents[e].updateCensus();if(t)return true}return false};return this};Kiwi.Plugins.AITree.AITreeInnerNode=function(e){Kiwi.Plugins.AITree.AITreeOuterNode.call(this,e);this.runsParent=false;this.children=[];this.currentlyRunningNode=undefined;this.shuffle=false;if(e!=undefined)if(e.shuffle)this.shuffle=e.shuffle;this.onUpdate=function(){if(this.shuffle)this.shuffleChildren()};this.addChild=function(e){if(e==undefined||this.children.indexOf(e)!=-1)return;if(this.hasAncestor(e)||this===e){return false}this.children.push(e);e.addParent(this);this.updateCensus();return true};this.removeChild=function(e){var t=this.children.indexOf(e);if(t!=-1){this.children.splice(t,1);e.removeParent(this);this.updateCensus()}};this.shuffleChildren=function(){var e=[];while(0<this.children.length){var t=Math.floor(Math.random()*this.children.length);e.push(this.children[t]);this.children.splice(t,1)}this.children=e};this.hasAncestor=function(e){if(this===e){return true}for(var t=0;t<this.parents.length;t++){var n=this.parents[t].hasAncestor(e);if(n)return true}return false};this.getDescendants=function(){var e=[];for(var t=0;t<this.children.length;t++){e.push(this.children[t]);if(this.children[t].getDescendants!=undefined){e=e.concat(this.children[t].getDescendants())}}return e};return this};Kiwi.Plugins.AITree.Sequencer=function(e){Kiwi.Plugins.AITree.AITreeInnerNode.call(this,e);this.run=function(){var e=0;if(this.currentlyRunningNode!=undefined){var t=this.children.indexOf(this.currentlyRunningNode);if(t!=-1){e=t}}for(var n=e;n<this.children.length;n++){var r=this.children[n].update();if(r==this.STATUS_RUNNING){if(this.children[n].runsParent){this.status=this.STATUS_RUNNING;this.currentlyRunningNode=this.children[n]}else{this.status=this.STATUS_SUCCESS;this.currentlyRunningNode=undefined}return}else this.currentlyRunningNode=undefined;if(r==this.STATUS_FAILURE){this.status=this.STATUS_FAILURE;return}}this.currentlyRunningNode=undefined;this.status=this.STATUS_SUCCESS};return this};Kiwi.Plugins.AITree.Selector=function(e){Kiwi.Plugins.AITree.AITreeInnerNode.call(this,e);this.run=function(){var e=0;if(this.currentlyRunningNode!=undefined){var t=this.children.indexOf(this.currentlyRunningNode);if(t!=-1){e=t}}for(var n=e;n<this.children.length;n++){var r=this.children[n].update();if(r==this.STATUS_RUNNING){if(this.children[n].runsParent){this.status=this.STATUS_RUNNING;this.currentlyRunningNode=this.children[n]}else{this.status=this.STATUS_SUCCESS;this.currentlyRunningNode=undefined}return}else this.currentlyRunningNode=undefined;if(r==this.STATUS_SUCCESS){this.status=this.STATUS_SUCCESS;return}}this.currentlyRunningNode=undefined;this.status=this.STATUS_FAILURE};return this};Kiwi.Plugins.AITree.UntilFailure=function(e){Kiwi.Plugins.AITree.AITreeInnerNode.call(this,e);this.run=function(){var e=0;if(this.currentlyRunningNode!=undefined){var t=this.children.indexOf(this.currentlyRunningNode);if(t!=-1){e=t}}while(0<this.children.length){var n=this.children[e].update();if(n==this.STATUS_RUNNING){if(this.children[e].runsParent){this.status=this.STATUS_RUNNING;this.currentlyRunningNode=this.children[e]}else{this.status=this.STATUS_SUCCESS;this.currentlyRunningNode=undefined}return}else this.currentlyRunningNode=undefined;if(n==this.STATUS_FAILURE){this.status=this.STATUS_SUCCESS;return}e++;if(this.children.length<=e)e=0}};return this};Kiwi.Plugins.AITree.UntilSuccess=function(e){Kiwi.Plugins.AITree.AITreeInnerNode.call(this,e);this.run=function(){var e=0;if(this.currentlyRunningNode!=undefined){var t=this.children.indexOf(this.currentlyRunningNode);if(t!=-1){e=t}}while(0<this.children.length){var n=this.children[e].update();if(n==this.STATUS_RUNNING){if(this.children[e].runsParent){this.status=this.STATUS_RUNNING;this.currentlyRunningNode=this.children[e]}else{this.status=this.STATUS_SUCCESS;this.currentlyRunningNode=undefined}return}else this.currentlyRunningNode=undefined;if(n==this.STATUS_SUCCESS){this.status=this.STATUS_SUCCESS;return}e++;if(this.children.length<=e)e=0}};return this};Kiwi.Plugins.AITree.UntilTime=function(e){Kiwi.Plugins.AITree.AITreeInnerNode.call(this,e);this.timerDuration=100;if(e!=undefined)if(e.timerDuration!=undefined)this.timerDuration=e.timerDuration;this.run=function(){var e=this.getTime()+this.timerDuration;var t=0;if(this.currentlyRunningNode!=undefined){var n=this.children.indexOf(this.currentlyRunningNode);if(n!=-1){t=n}}while(this.getTime()<e){var r=this.children[t].update();if(r==this.STATUS_RUNNING){if(this.children[t].runsParent){this.status=this.STATUS_RUNNING;this.currentlyRunningNode=this.children[t]}else{this.status=this.STATUS_SUCCESS;this.currentlyRunningNode=undefined}return}t++;if(this.children.length<=t)t=0}this.status=this.STATUS_SUCCESS};this.getTime=function(){if(window.performance.now)return window.performance.now();if(window.performance.webkitNow)return window.performance.webkitNow();return(new Date).getTime()};return this}